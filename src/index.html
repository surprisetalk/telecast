<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Telecasts</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div id="app" class="flex-rows">
      <div class="flex-rows">
        <div class="search-bar">
          <button id="back" style="display: none">‚Üê</button>
          <input id="search" placeholder="Search..." />
          <button id="search-btn">Search</button>
        </div>
        <div id="channels" class="grid"></div>
        <div id="episodes" class="grid"></div>
      </div>
      <div id="watch">
        <video id="player" controls></video>
      </div>
    </div>

    <script>
      const state = {
        favorites: new Set(
          JSON.parse(localStorage.getItem("favorites") || "[]"),
        ),
        watchHistory: new Set(
          JSON.parse(localStorage.getItem("watchHistory") || "[]"),
        ),
        currentChannel: null,
      };

      const saveFavorites = () =>
        localStorage.setItem("favorites", JSON.stringify([...state.favorites]));
      const saveWatchHistory = () =>
        localStorage.setItem(
          "watchHistory",
          JSON.stringify([...state.watchHistory]),
        );

      const searchInput = document.querySelector("input");
      const channelsGrid = document.querySelector("#channels");
      const episodesContainer = document.querySelector("#episodes");
      const watchContainer = document.querySelector("#watch");

      const renderChannelHeader = (channel) => `
        <div class="channel-header">
          <h2>${channel.title}</h2>
          <p>${channel.description || ""}</p>
          <button onclick="toggleFavorite('${channel.id}')" class="favorite-btn">
            ${state.favorites.has(channel.id) ? "Unfollow" : "Follow"}
          </button>
        </div>
      `;

      async function fetchEpisodes(channel) {
        state.currentChannel = channel;
        episodesContainer.innerHTML = renderChannelHeader(channel);

        const endpoint =
          channel.type === "youtube" ? "/yt-episodes" : "/episodes";
        const response = await fetch(`${endpoint}?id=${channel.id}`);
        const episodes = await response.json();

        const episodesGrid = document.createElement("div");
        episodesGrid.className = "grid";

        episodes.forEach((episode) => {
          const watched = state.watchHistory.has(episode.id);
          episodesGrid.innerHTML += `
            <div class="card ${watched ? "watched" : ""}" onclick="playEpisode(${JSON.stringify(episode)})">
              <img src="${episode.thumbnail}" class="thumbnail" alt="${episode.title}">
              <h3>${episode.title}</h3>
            </div>
          `;
        });

        episodesContainer.appendChild(episodesGrid);
      }

      function playEpisode(episode) {
        state.watchHistory.add(episode.id);
        saveWatchHistory();

        watchContainer.className = "active";
        watchContainer.innerHTML = `
          <video controls autoplay>
            <source src="${episode.src}" type="video/mp4">
          </video>
          <h3>${episode.title}</h3>
        `;
      }

      function toggleFavorite(channelId) {
        if (state.favorites.has(channelId)) {
          state.favorites.delete(channelId);
        } else {
          state.favorites.add(channelId);
        }
        saveFavorites();

        if (state.currentChannel) {
          const header = document.querySelector(".channel-header");
          header.querySelector(".favorite-btn").textContent =
            state.favorites.has(channelId) ? "Unfollow" : "Follow";
        }
      }
    </script>

    <script>
      const app = {
        init() {
          this.elems = {
            back: document.getElementById("back"),
            search: document.getElementById("search"),
            searchBtn: document.getElementById("search-btn"),
            channels: document.getElementById("channels"),
            episodes: document.getElementById("episodes"),
            watch: document.getElementById("watch"),
            player: document.getElementById("player"),
          };

          this.elems.searchBtn.onclick = () => this.handleSearch();
          this.elems.search.onkeyup = (e) =>
            e.key === "Enter" && this.handleSearch();
          this.elems.back.onclick = () => this.handleBack();
        },

        async handleSearch() {
          const query = this.elems.search.value.trim();
          if (!query) return;

          const feeds = await fetch(
            `/channels?q=${encodeURIComponent(query)}`,
          ).then((r) => r.json());
          this.renderChannels(feeds);
          this.elems.back.style.display = "block";
          this.elems.episodes.innerHTML = "";
        },

        async handleFeed(id) {
          const route = parseInt(id) ? "episodes" : "yt-episodes";
          const episodes = await fetch(`/${route}?id=${id}`).then((r) =>
            r.ok ? r.json() : [],
          );
          this.renderEpisodes(episodes);
          this.elems.channels.innerHTML = "";
        },

        handlePlay(episode) {
          this.elems.watch.classList.add("active");
          this.elems.player.src = episode.src;
          this.elems.player.play();
        },

        handleBack() {
          if (this.elems.episodes.innerHTML) {
            this.elems.episodes.innerHTML = "";
            this.elems.channels.innerHTML = this.lastChannels;
          } else {
            this.elems.search.value = "";
            this.elems.channels.innerHTML = "";
            this.elems.back.style.display = "none";
          }
        },

        renderChannels(feeds) {
          this.lastChannels = feeds
            .map(
              (feed) => `
                    <div class="card" onclick="app.handleFeed('${feed.id}')">
                        <img class="thumbnail" src="${feed.thumbnail}" alt="">
                        <div>${feed.title}</div>
                    </div>
                `,
            )
            .join("");
          this.elems.channels.innerHTML = this.lastChannels;
        },

        renderEpisodes(episodes) {
          this.elems.episodes.innerHTML = episodes
            .map(
              (episode) => `
                    <div class="card" onclick='app.handlePlay(${JSON.stringify(episode).replace(/"/g, "&quot;")})'>
                        <img class="thumbnail" src="${episode.thumbnail}" alt="">
                        <div>${episode.title}</div>
                    </div>
                `,
            )
            .join("");
        },
      };

      app.init();
    </script>
  </body>
</html>
