<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Explorer</title>
    <style>
      .flex-rows {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 0.5rem;
        cursor: pointer;
      }
      .card:hover {
        transform: translateY(-2px);
      }
      .thumbnail {
        width: 100%;
        aspect-ratio: 16/9;
        object-fit: cover;
        border-radius: 4px;
      }
      #watch {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        padding: 1rem;
        border-top: 1px solid #ddd;
        display: none;
      }
      #watch.active {
        display: block;
      }
      video {
        width: 100%;
        max-height: 70vh;
      }
      button {
        padding: 0.5rem 1rem;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
      }
      input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .search-bar {
        display: flex;
        gap: 1rem;
      }
    </style>
  </head>
  <body>
    <div id="app" class="flex-rows">
      <div class="flex-rows">
        <div class="search-bar">
          <button id="back" style="display: none">‚Üê</button>
          <input id="search" placeholder="Search..." />
          <button id="search-btn">Search</button>
        </div>
        <div id="channels" class="grid"></div>
        <div id="episodes" class="grid"></div>
      </div>
      <div id="watch">
        <video id="player" controls></video>
      </div>
    </div>

    <script>
      const app = {
        init() {
          this.elements = {
            back: document.getElementById("back"),
            search: document.getElementById("search"),
            searchBtn: document.getElementById("search-btn"),
            channels: document.getElementById("channels"),
            episodes: document.getElementById("episodes"),
            watch: document.getElementById("watch"),
            player: document.getElementById("player"),
          };

          this.elements.searchBtn.onclick = () => this.handleSearch();
          this.elements.search.onkeyup = (e) =>
            e.key === "Enter" && this.handleSearch();
          this.elements.back.onclick = () => this.handleBack();
        },

        async handleSearch() {
          const query = this.elements.search.value.trim();
          if (!query) return;

          const feeds = await fetch(
            `/search?q=${encodeURIComponent(query)}`,
          ).then((r) => r.json());
          this.renderChannels(feeds);
          this.elements.back.style.display = "block";
          this.elements.episodes.innerHTML = "";
        },

        async handleFeed(id) {
          const episodes = await fetch(`/episodes?id=${id}`).then((r) =>
            r.json(),
          );
          this.renderEpisodes(episodes);
          this.elements.channels.innerHTML = "";
        },

        handlePlay(episode) {
          this.elements.watch.classList.add("active");
          this.elements.player.src = episode.src;
          this.elements.player.play();
        },

        handleBack() {
          if (this.elements.episodes.innerHTML) {
            this.elements.episodes.innerHTML = "";
            this.elements.channels.innerHTML = this.lastChannels;
          } else {
            this.elements.search.value = "";
            this.elements.channels.innerHTML = "";
            this.elements.back.style.display = "none";
          }
        },

        renderChannels(feeds) {
          this.lastChannels = feeds
            .map(
              (feed) => `
                    <div class="card" onclick="app.handleFeed(${feed.id})">
                        <img class="thumbnail" src="${feed.thumbnail}" alt="">
                        <div>${feed.title}</div>
                    </div>
                `,
            )
            .join("");
          this.elements.channels.innerHTML = this.lastChannels;
        },

        renderEpisodes(episodes) {
          this.elements.episodes.innerHTML = episodes
            .map(
              (episode) => `
                    <div class="card" onclick='app.handlePlay(${JSON.stringify(episode).replace(/"/g, "&quot;")})'>
                        <img class="thumbnail" src="${episode.thumbnail}" alt="">
                        <div>${episode.title}</div>
                    </div>
                `,
            )
            .join("");
        },
      };

      app.init();
    </script>
  </body>
</html>
